<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title>Plain Text Double-Entry Accounting Using Beancount - Jean-Fran√ßois Parent&#39;s Blog</title>
  <meta charset="utf-8" />
  <meta name="author" content="Jean-Francois Parent" />
    <meta name="description" content="" />
    <meta name="keywords" content="python,finance" />
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154154057-1"></script>
  <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());

   gtag('config', 'UA-154154057-1');
  </script>
  <script async src="https://code.jquery.com/jquery-latest.min.js" async></script>
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
  <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <script async src="/media/js/main.js"></script>
  <script async src="/media/highlight/highlight.pack.js"></script>
  <script>
   hljs.initHighlightingOnLoad();
   document.querySelectorAll('pre.src').forEach((block) => {
     hljs.highlightBlock(block);
   });
  </script>
  <link rel="shortcut icon" href="/media/images/penrose_rhombus_tiling.ico" />
  <link rel="stylesheet" href="/media/css/style.css">
  <link rel="stylesheet" href="/media/fontawesome-free-5.11.2-web/css/all.css">
  <link rel="stylesheet" href="/media/highlight/styles/railscasts.css">
  <style type="text/css">
   /* Mathjax */
   .MathJax_Display {
     background: white !important;
   }
  </style>
</head>

  <body class="container">
    <nav class="main-nav">
  <a href="/">
    <img class="home-logo" src="/media/images/penrose_rhombus_tiling.png" />
  </a>
  <a href="/tags">Tags</a>
  <a href="/about/">About</a>
  <a href="/boudoir/">Boudoir</a>
  <a href="https://github.com/jf-parent" target="_blank"><i style="font-size: 30px;" class="fab fa-github-square"></i></a>
  <a href="https://twitter.com/hacker_pyrat" target="_blank"><i style="font-size: 30px;" class="fab fa-twitter-square"></i></a>
  <a href="https://www.linkedin.com/in/parentjf/" target="_blank"><i style="font-size: 30px;" class="fab fa-linkedin"></i></a>
</nav>

    <div>
    <section id="wrapper">
        <article class="post">
            <header>
                    <h1>Plain Text Double-Entry Accounting Using Beancount</h1>
            </header>
            <br />
            <section id="post-body">
                
<div id="outline-container-orge415882" class="outline-2">
<h2 id="orge415882">Introduction</h2>
<div class="outline-text-2" id="text-orge415882">
</div>
<div id="outline-container-orgf121f1e" class="outline-3">
<h3 id="orgf121f1e">I discover Plain Text Double Entry Accounting on HackerNews earlier this year. After some experimentation, I decided to adopt it.</h3>
</div>
<div id="outline-container-orgd13935f" class="outline-3">
<h3 id="orgd13935f">Below I will share some interesting resources and code samples.</h3>
</div>
<div id="outline-container-orgfa68203" class="outline-3">
<h3 id="orgfa68203">The beancount documentation is very exhaustive and beginner friendly.</h3>
</div>
</div>
<div id="outline-container-org47cf482" class="outline-2">
<h2 id="org47cf482">Resources</h2>
<div class="outline-text-2" id="text-org47cf482">
</div>
<div id="outline-container-org323c8dc" class="outline-3">
<h3 id="org323c8dc"><a href="https://github.com/beancount/fava">beancount/fava: Fava - web interface for Beancount</a></h3>
<div class="outline-text-3" id="text-org323c8dc">
<img src="/media/images/fava.png" />
</div>
</div>
<div id="outline-container-orgdd9bf77" class="outline-3">
<h3 id="orgdd9bf77"><a href="https://github.com/beancount/beancount-mode">beancount/beancount-mode: Emacs major-mode to work with Beancount ledger files</a></h3>
</div>
<div id="outline-container-org570b14b" class="outline-3">
<h3 id="org570b14b"><a href="https://github.com/nathangrigg/vim-beancount">nathangrigg/vim-beancount: Vim ftplugin for beancount</a></h3>
</div>
<div id="outline-container-orga6c54ea" class="outline-3">
<h3 id="orga6c54ea"><a href="https://github.com/csingley/ofxtools">csingley/ofxtools: Python OFX Library</a></h3>
</div>
<div id="outline-container-orgef4cbaa" class="outline-3">
<h3 id="orgef4cbaa"><a href="https://plaintextaccounting.org/">Plain Text Accounting, a guide to Ledger and friends - plaintextaccounting.org</a></h3>
</div>
<div id="outline-container-orgd759dde" class="outline-3">
<h3 id="orgd759dde"><a href="https://beancount.github.io/docs/the_double_entry_counting_method.html">The Double Entry Counting Method - Beancount Documentation</a></h3>
</div>
</div>
<div id="outline-container-orgaa33f3d" class="outline-2">
<h2 id="orgaa33f3d">Importer for qfx/ofx</h2>
<div class="outline-text-2" id="text-orgaa33f3d">
</div>
<div id="outline-container-org76d3bc5" class="outline-3">
<h3 id="org76d3bc5">Features</h3>
<div class="outline-text-3" id="text-org76d3bc5">
</div>
<div id="outline-container-org65795e5" class="outline-4">
<h4 id="org65795e5">Deduplication using transaction hash</h4>
</div>
<div id="outline-container-orga2d9bde" class="outline-4">
<h4 id="orga2d9bde">Auto-resolve Payee (hardcoded hashmap)</h4>
</div>
<div id="outline-container-orgdfe14ba" class="outline-4">
<h4 id="orgdfe14ba">Auto-categorize Posting (hardcoded hashmap)</h4>
</div>
</div>
<div id="outline-container-orge21e982" class="outline-3">
<h3 id="orge21e982">Code</h3>
<div class="outline-text-3" id="text-orge21e982">
<div class="org-src-container">
<pre class="src src-Python">from datetime import datetime, timedelta, date
import os.path
import sys
import logging

sys.path.append('.')

# pip install beancount
from beancount.core import data
from beancount.loader import load_file
from beancount.core.amount import Amount
from beancount.ingest.importer import ImporterProtocol
# pip install ofxtools
from ofxtools.Parser import OFXTree

# Just a python dictionary mapping a Transaction's narration to a Payee and Category
from importers.resolver import categories, payees

logging.basicConfig(level=logging.INFO)

class QFXImporter(ImporterProtocol):
    def __init__(self, account, account_id, beancount_file, current_year):
        self.account = account
        self.account_id = account_id
        self.currency = 'CAD'
        self.beancount_file = beancount_file

        self.period_date_start = date(current_year, 1, 1)
        self.period_date_end = date(current_year, 12, 31)
        self.date_start = None
        self.date_end = None

        self.parser = OFXTree()

        self.transactions_hash_set = self.index_beancount(self.beancount_file)

        super().__init__()

    def get_transaction_hash(self, t):
        return f"{t.postings[0].account}|{t.date.isoformat()}|{t.narration}|{t.postings[0].units}"

    def index_beancount(self, file_):
        logging.info(f"Indexing: {file_}")
        entries, _, _ = load_file(file_)

        transactions_hash = []
        for entry in entries:
            if type(entry) == data.Transaction:
                transactions_hash.append(self.get_transaction_hash(entry))

        return set(transactions_hash)

    def parse(self, file_):
        with open(file_.name, 'rb') as f:
            self.parser.parse(f)

        return self.parser.convert()

    def identify(self, file_):
        ofx = self.parse(file_)

        return ofx.statements[0].acctid == self.account_id

    def extract(self, file_):
        if not self.identify(file_):
            return []

        ofx = self.parse(file_)

        entries = []
        balance_amount = None
        with open(file_.name) as fd:
            lines = ofx.statements[0].banktranlist

            self.date_start = ofx.statements[0].banktranlist.dtstart.date()
            self.date_end = ofx.statements[0].banktranlist.dtend.date()

            try:
                balance_amount = Amount(ofx.statements[0].availbal.balamt, self.currency)
            except AttributeError:
                balance_amount = None

            for i, line in enumerate(lines):
                meta = data.new_metadata(file_.name, i)

                amount = Amount(line.trnamt, self.currency)
                date = line.dtposted.date()
                description = line.name
                category = categories.get(description) or "Unknown:TODO"
                payee = payees.get(description) or "Unknown"

                postings = [
                    data.Posting(self.account, amount, None, None, None, None),
                    data.Posting(category, None, None, None, None, None)
                ]

                new_transaction = data.Transaction(
                        meta,
                        date,
                        self.FLAG,
                        payee,
                        description,
                        data.EMPTY_SET,
                        data.EMPTY_SET,
                        postings
                    )

                transaction_hash = self.get_transaction_hash(new_transaction)

                if date &lt; self.period_date_start or date &gt; self.period_date_end:
                    logging.warning(f"Skipping =&gt; transaction before or after relevant period: {transaction_hash}")
                    continue

                if transaction_hash not in self.transactions_hash_set:
                    logging.info(f"New transaction: {transaction_hash}")
                    entries.append(new_transaction)
                else:
                    logging.warning(f"Skipping =&gt; {transaction_hash}")

            meta = data.new_metadata(fd.name, 0)

            if balance_amount:
                entries.append(
                    data.Balance(
                        meta,
                        self.date_end + timedelta(days=1),
                        self.account,
                        balance_amount,
                        None,
                        None
                    )
                )

            return entries

    def file_account(self, file_):
        return self.account

    def file_date(self, file_):
        self.extract(file_)
        return self.date_end

    def file_name(self, file_):
        _, extension = os.path.splitext(os.path.basename(file_.name))
        return f'XXX{extension}'
</pre>
</div>
</div>
</div>
</div>

            </section>
    </section>
</div>

        <div>
    <section id="wrapper">
      <div class="post-meta">
        <span title="post date" class="post-info">2021-12-18</span>
        <span title="tags" class="post-info"><a href="/tags/python/">Python</a>, <a href="/tags/finance/">Finance</a></span>
      </div>
      <br />
      <br />
      <div align="center">
      <footer id="footer">
        <p class="small">
          Copyright &copy; 2018 - <span id="footerYear"></span> - Jean-Francois Parent
          &nbsp;&nbsp;-&nbsp;&nbsp;
          Powered by <a href="https://github.com/jf-parent/org-page" target="_blank">org-page</a>
          <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
        </p>
        <br />
      </footer>
      </div>
      </section>
    </div>

  </body>
</html>
